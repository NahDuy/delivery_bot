#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <ArduinoJson.h>

// ThÃ´ng tin Wi-Fi
const char* ssid = "La Tra 1";
const char* password = "";

// Äá»‹a chá»‰ IP Flask server (mÃ¡y báº¿p)
const char* serverUrl = "http://192.168.1.24:5000/orders";
const char* returnUrl = "http://192.168.1.24:5000/static/return_command.json";

// Ghi nhá»› Ä‘Æ¡n cuá»‘i cÃ¹ng
String lastTable = "";
String lastDish = "";

void setup() {  
  Serial.begin(115200);
  delay(1000);

  WiFi.begin(ssid, password);
  Serial.print("Äang káº¿t ná»‘i WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… Káº¿t ná»‘i WiFi thÃ nh cÃ´ng!");
}

void executeCommand(JsonArray cmds) {
  Serial.println("ğŸš— Báº¯t Ä‘áº§u thá»±c thi lá»‡nh:");
  for (JsonObject cmd : cmds) {
    serializeJson(cmd, Serial);
    Serial.println();

    if (cmd.containsKey("T")) {
      int steps = cmd["T"];
      Serial.printf("â¡ï¸ Tiáº¿n %d bÆ°á»›c\n", steps);
      // moveForward(steps);
    } else if (cmd.containsKey("A")) {
      int deg = cmd["A"];
      Serial.printf("ğŸ”„ Quay %d Ä‘á»™ táº¡i chá»—\n", deg);
      // rotateInPlace(deg);
    } else if (cmd.containsKey("AL")) {
      Serial.println("â†©ï¸ Ráº½ trÃ¡i 90 Ä‘á»™");
      // turnLeft90();
    } else if (cmd.containsKey("AR")) {
      Serial.println("â†ªï¸ Ráº½ pháº£i 90 Ä‘á»™");
      // turnRight90();
    }
  }
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    WiFiClient client;
    HTTPClient http;
    http.begin(client, serverUrl);
    int httpCode = http.GET();

    if (httpCode == HTTP_CODE_OK) {
      String payload = http.getString();
      DynamicJsonDocument doc(2048);
      deserializeJson(doc, payload);
      JsonArray orders = doc.as<JsonArray>();

      if (orders.size() > 0) {
        JsonObject last = orders[orders.size() - 1];
        String currentTable = last["table"].as<String>();
        String currentDish = last["dish"].as<String>();

        if (currentTable != lastTable || currentDish != lastDish) {
          Serial.printf("ğŸ§¾ BÃ n: %s | MÃ³n: %s\n", currentTable.c_str(), currentDish.c_str());

          JsonArray commands = last["commands"];
          executeCommand(commands);

          // âœ… Chá» lá»‡nh quay vá» tá»« báº¿p
          bool returnReceived = false;
          for (int i = 0; i < 15; i++) {  // 15 láº§n Ã— 2s = 30s
            Serial.println("â³ Chá» lá»‡nh quay vá» tá»« báº¿p...");
            delay(2000);

            HTTPClient returnHttp;
            WiFiClient returnClient;
            returnHttp.begin(returnClient, returnUrl);
            int returnCode = returnHttp.GET();

            if (returnCode == HTTP_CODE_OK) {
              String returnPayload = returnHttp.getString();
              DynamicJsonDocument returnDoc(1024);
              DeserializationError err = deserializeJson(returnDoc, returnPayload);

              if (!err) {
                JsonArray returnPath = returnDoc.as<JsonArray>();
                Serial.println("ğŸ“¦ Nháº­n lá»‡nh quay vá»:");
                executeCommand(returnPath);
                returnReceived = true;
                break;
              }
            }

            returnHttp.end();
          }

          if (!returnReceived) {
            Serial.println("âš ï¸ KhÃ´ng nháº­n Ä‘Æ°á»£c lá»‡nh quay vá» sau 30 giÃ¢y.");
          }

          // âœ… Cáº­p nháº­t Ä‘Æ¡n Ä‘Ã£ xá»­ lÃ½
          lastTable = currentTable;
          lastDish = currentDish;
        } else {
          Serial.println("ğŸ•’ KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng má»›i, chá»...");
        }
      }
    }
    http.end();
  }

  delay(5000);  // kiá»ƒm tra láº¡i sau 5 giÃ¢y
}
